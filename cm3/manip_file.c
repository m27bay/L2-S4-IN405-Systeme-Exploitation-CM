#include "manip_file.h"

int count_file(const char *path, const int mode) {
  if(!path) { // If path is null
    fprintf(stderr, "Error in 'count()': '%s' is null.\n", path);
    exit(PTR_NULL);
  }

  DIR *dir; // Open the dir
  struct dirent *entry; // Information of dire
  struct stat stat_info; // Information of file

  int num_sub_files = 0; // nbr of file in a subfolder/ subdirectory
  int num_files = 0;

  char ent_path[1024] = "\0"; // Save the path

  dir = opendir(path);
  if(!dir) { // can't open
    fprintf(stderr, "Error in 'count()': can't open the directory '%s'.\nCheck if the directory exit.\n", path);
    exit(PTR_NULL);
  }

  printf("Calculating number of file(s)...\n");

  // Else i'm in a dir
  while((entry = readdir(dir)))
  {
    if(entry->d_name[0] == '.')
      continue;

    ent_path[0] = '\0'; // reset the path

    strcat(ent_path, path); // Save the path
    strcat(ent_path, "/");
    strcat(ent_path, entry->d_name);

    if(stat(ent_path, &stat_info)) {
      perror("Error");
      exit(1);
    }

    if(S_ISREG(stat_info.st_mode))// test if file is a regular file
      ++num_files;
    if(S_ISDIR(stat_info.st_mode))// test if file is a directory
      num_sub_files += count_file(ent_path, mode); // count file inthe directory
  }

  closedir(dir);

  if(mode  ==  M_PRINT)
    printf("Path: '%s'\nNumber of file(s): %d.\n", path, num_files);

  return num_files+num_sub_files;
}

int count_dir(const char *path) {
  if(!path) { // If path is null
    fprintf(stderr, "Error in 'count()': '%s' is null.\n", path);
    exit(PTR_NULL);
  }

  DIR *dir; // Open the dir
  struct dirent *entry; // Information of dire
  struct stat stat_info; // Information of file

  int num_dir = 0;

  char ent_path[1024] = "\0"; // Save the path

  dir = opendir(path);
  if(!dir) { // can't open
    fprintf(stderr, "Error in 'count()': can't open the directory '%s'.\nCheck if the directory exit.\n", path);
    exit(PTR_NULL);
  }

  printf("Calculating number of directory(ies)...\n");

  // Else i'm in a dir
  while((entry = readdir(dir)))
  {
    if(entry->d_name[0] == '.')
      continue;

    ent_path[0] = '\0'; // reset the path

    strcat(ent_path, path); // Save the path
    strcat(ent_path, "/");
    strcat(ent_path, entry->d_name);

    if(stat(ent_path, &stat_info)) {
      perror("Error");
      exit(1);
    }

    if(S_ISDIR(stat_info.st_mode))// test if file is a directory
      ++num_dir;
  }

  closedir(dir);

  return num_dir;
}

int count_link(const char *path) {
  if(!path) { // If path is null
    fprintf(stderr, "Error in 'count()': '%s' is null.\n", path);
    exit(PTR_NULL);
  }

  DIR *dir; // Open the dir
  struct dirent *entry; // Information of dire
  struct stat stat_info; // Information of file

  int num_link = 0;

  char ent_path[1024] = "\0"; // Save the path

  dir = opendir(path);
  if(!dir) { // can't open
    fprintf(stderr, "Error in 'count()': can't open the directory '%s'.\nCheck if the directory exit.\n", path);
    exit(PTR_NULL);
  }

  printf("Calculating number of link(s)...\n");

  // Else i'm in a dir
  while((entry=readdir(dir)))
  {
    if(entry->d_name[0] == '.')
      continue;

    ent_path[0] = '\0'; // reset the path

    strcat(ent_path, path); // Save the path
    strcat(ent_path, "/");
    strcat(ent_path, entry->d_name);

    if(lstat(ent_path, &stat_info)) {
      perror("Error");
      exit(1);
    }
    if(S_ISLNK(stat_info.st_mode)) // test if file is a link
      ++num_link;
  }

  closedir(dir);

  return num_link;
}

int count(const char *path, const char *type_file) {
  if(!path) {
    fprintf(stderr, "Error in 'count()': '%s' is null.\n", path);
    exit(PTR_NULL);
  }

  DIR *directory;
  struct dirent *file;
  struct stat stat_info; // File information(s)

  int num = 0;

  char path_read[1024] = "\0"; // Save the path

  directory = opendir(path);
  if(!directory) { // can't open
    fprintf(stderr, "Error in 'count()': can't open the directory '%s'.\nCheck if the directory exit.\n", path);
    exit(PTR_NULL);
  }

  // Else i'm in a dir
  while((file=readdir(directory)))
  {
    if(file->d_name[0] == '.')
      continue;

    path_read[0] = '\0'; // reset the path

    strcat(path_read, path); // Save the path
    strcat(path_read, "/");
    strcat(path_read, file->d_name);

    stat(path_read, &stat_info);
    if(strcmp(type_file, "file")==0) {
      if(S_ISREG(stat_info.st_mode))
        ++num;
    }
    else
      printf("File type unknonw.\n");
  }

  closedir(directory);

  return num;
}
